<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level 0: Bare Connection</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 {
            color: #4ec9b0;
            border-bottom: 2px solid #4ec9b0;
            padding-bottom: 10px;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .disconnected {
            background: #3e1e1e;
            color: #f48771;
            border: 2px solid #f48771;
        }
        .connected {
            background: #1e3e1e;
            color: #4ec9b0;
            border: 2px solid #4ec9b0;
        }
        .log {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border: 1px solid #3e3e42;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #007acc;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #005a9e;
        }
        button:disabled {
            background: #3e3e42;
            cursor: not-allowed;
        }
        .info {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #4ec9b0;
        }
    </style>
</head>
<body>
    <h1>üåâ Level 0: Bare WebSocket Connection</h1>
    
    <div class="info">
        <strong>Goal:</strong> Prove BifrostClient pattern works - no UI, no database, no commands<br>
        <strong>Test:</strong> Can client connect to ws://localhost:8765 with hooks?<br>
        <strong>Using:</strong> Simplified BifrostClient wrapper (same API as production client)
    </div>

    <div id="status" class="status disconnected">
        ‚ùå Disconnected
    </div>

    <div>
        <button id="connectBtn" onclick="connect()">Connect</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <h2>Connection Log</h2>
    <div id="log" class="log"></div>

    <script type="module">
        // Import BifrostClient from local copy (CDN has module resolution issues)
        // For production, host the client files on your server
        // Alternative: Use https://cdn.jsdelivr.net/npm/zolo-zcli@1.5.4/dist/bifrost-client.min.js (when available)
        
        // For now, use a simple WebSocket wrapper
        class SimpleBifrostClient {
            constructor(url, options = {}) {
                this.url = url;
                this.options = options;
                this.ws = null;
                this.hooks = options.hooks || {};
            }

            async connect() {
                return new Promise((resolve, reject) => {
                    this.ws = new WebSocket(this.url);
                    
                    this.ws.onopen = () => {
                        console.log('WebSocket opened');
                    };
                    
                    this.ws.onmessage = (event) => {
                        try {
                            const msg = JSON.parse(event.data);
                            console.log('Message:', msg);
                            
                            if (msg.event === 'connection_info') {
                                if (this.hooks.onConnected) {
                                    this.hooks.onConnected(msg.data);
                                }
                                resolve();
                            } else {
                                if (this.hooks.onMessage) {
                                    this.hooks.onMessage(msg);
                                }
                            }
                            
                            if (this.hooks.onBroadcast) {
                                this.hooks.onBroadcast(msg);
                            }
                        } catch (e) {
                            console.log('Non-JSON message:', event.data);
                        }
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        if (this.hooks.onError) {
                            this.hooks.onError(error);
                        }
                        reject(error);
                    };
                    
                    this.ws.onclose = (event) => {
                        console.log('WebSocket closed:', event);
                        if (this.hooks.onDisconnected) {
                            this.hooks.onDisconnected(event.reason || 'Connection closed');
                        }
                    };
                });
            }

            disconnect() {
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
            }

            isConnected() {
                return this.ws && this.ws.readyState === WebSocket.OPEN;
            }
        }

        // Use SimpleBifrostClient instead of BifrostClient for Level 0
        const BifrostClient = SimpleBifrostClient;

        let client = null;
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `<span style="color: #858585;">[${timestamp}]</span> ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Also log to browser console for debugging
            const cleanMsg = message.replace(/<[^>]*>/g, '');
            console.log(`[Level0] [${timestamp}] ${cleanMsg}`);
        }

        function updateStatus(connected) {
            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.innerHTML = '‚úÖ Connected to ws://localhost:8765';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.innerHTML = '‚ùå Disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        window.connect = async function() {
            if (client && client.isConnected()) {
                log('‚ö†Ô∏è Already connected', 'warn');
                return;
            }

            log('üîå Attempting to connect using BifrostClient...');
            
            try {
                // Initialize BifrostClient with hooks
                client = new BifrostClient('ws://localhost:8765', {
                    autoTheme: false,  // Level 0: No UI rendering yet
                    autoReconnect: true,
                    debug: true,
                    hooks: {
                        onConnected: (info) => {
                            log('‚úÖ <strong>Connected via BifrostClient!</strong>', 'success');
                            log(`üì¶ Server version: ${info.server_version || 'unknown'}`, 'info');
                            log(`üéØ Features: ${info.features ? info.features.join(', ') : 'none'}`, 'info');
                            console.log('[Level0] Connection info:', info);
                            updateStatus(true);
                        },
                        onDisconnected: (reason) => {
                            log(`üîå Disconnected: ${reason}`, 'info');
                            console.log('[Level0] Disconnected:', reason);
                            updateStatus(false);
                        },
                        onMessage: (msg) => {
                            log(`üì® Message: <span style="color: #4ec9b0;">${JSON.stringify(msg).substring(0, 100)}...</span>`, 'message');
                            console.log('[Level0] Message received:', msg);
                        },
                        onError: (error) => {
                            log(`‚ùå Error: ${error.message || error}`, 'error');
                            console.error('[Level0] Error:', error);
                        },
                        onBroadcast: (msg) => {
                            log(`üì° Broadcast: ${msg.event || 'unknown'}`, 'info');
                            console.log('[Level0] Broadcast:', msg);
                        }
                    }
                });

                // Connect to server
                await client.connect();
                
            } catch (error) {
                log(`‚ùå Failed to connect: ${error.message}`, 'error');
                console.error('[Level0] Connection failed:', error);
                updateStatus(false);
            }
        }

        window.disconnect = function() {
            if (client) {
                log('üîå Disconnecting via BifrostClient...');
                client.disconnect();
                client = null;
            }
        }

        window.clearLog = function() {
            logDiv.innerHTML = '';
        }

        // Auto-connect on load
        window.addEventListener('load', () => {
            log('üöÄ Level 0 Demo loaded - BifrostClient ready');
            console.log('[Level0] Client initialized');
            console.log('[Level0] Using: BifrostClient from CDN');
            console.log('[Level0] Target server: ws://localhost:8765');
            console.log('[Level0] Browser:', navigator.userAgent);
        });

        // Log any unhandled errors
        window.addEventListener('error', (event) => {
            console.error('[Level0] Unhandled error:', event.error);
            log(`‚ö†Ô∏è Client error: ${event.message}`, 'error');
        });
    </script>
</body>
</html>

