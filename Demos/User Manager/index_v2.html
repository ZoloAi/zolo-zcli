<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Manager v2 - zCLI</title>
    
    <!-- Load zTheme CSS -->
    <link rel="stylesheet" href="../../zCLI/utils/zTheme/css/css_vars.css">
    <link rel="stylesheet" href="../../zCLI/utils/zTheme/css/zMain.css">
    <link rel="stylesheet" href="../../zCLI/utils/zTheme/css/zButtons.css">
    <link rel="stylesheet" href="../../zCLI/utils/zTheme/css/zTables.css">
    <link rel="stylesheet" href="../../zCLI/utils/zTheme/css/zInputs.css">
    <link rel="stylesheet" href="../../zCLI/utils/zTheme/css/zContainers.css">
    <link rel="stylesheet" href="../../zCLI/utils/zTheme/css/zPanels.css">
    <link rel="stylesheet" href="../../zCLI/utils/zTheme/css/zAlerts.css">
    <link rel="stylesheet" href="../../zCLI/utils/zTheme/css/zDashboard.css">
</head>
<body>
    <div class="zContainer">
        <h1 style="font-size: 3em; margin-bottom: 0.2em;">ğŸ‘¥ User Manager v2</h1>
        <p style="font-size: 1.2em; color: #6b7280; margin-bottom: 2rem;">Powered by zCLI + BifrostClient + zTheme</p>
        
        <div class="dashCard" style="margin-bottom: 2rem;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div id="status" style="width: 16px; height: 16px; border-radius: 50%; background: #ef4444;"></div>
                <strong id="statusText">Connecting...</strong>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 280px 1fr; gap: 2rem;">
            <div class="dashCard">
                <h3 style="margin-bottom: 1rem;">Actions</h3>
                <div id="menu"></div>
            </div>
            <div class="dashCard" id="content" style="min-height: 500px;">
                <div style="text-align: center; padding: 60px;">
                    <h2 style="font-size: 2em;">ğŸ”„ Initializing...</h2>
                </div>
            </div>
        </div>
    </div>

    <script src="../../zCLI/subsystems/zComm/zComm_modules/zBifrost/bifrost_client.js"></script>
    
    <script>
        let client;

        (async () => {
            client = new BifrostClient('ws://localhost:8765', {
                autoTheme: false,  // CSS already loaded in HTML
                debug: true,
                hooks: {
                    onConnected: () => {
                        updateStatus(true);
                        renderMenu();
                        showWelcome();
                    },
                    onDisconnected: () => updateStatus(false)
                }
            });

            await client.connect();
        })();

        function updateStatus(connected) {
            document.getElementById('status').style.background = connected ? '#10b981' : '#ef4444';
            document.getElementById('statusText').textContent = connected ? 'Connected' : 'Reconnecting...';
        }

        function renderMenu() {
            client.renderMenu([
                { label: 'ğŸ”§ Setup DB', action: setupDB },
                { label: 'ğŸ“‹ List Users', action: listUsers },
                { label: 'â• Add User', action: addUser },
                { label: 'ğŸ” Search', action: search },
                { label: 'ğŸ—‘ï¸ Delete User', action: deleteUser }
            ], '#menu');
        }

        function showWelcome() {
            document.getElementById('content').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h2 style="font-size: 2.5em; margin-bottom: 1rem;">ğŸ‰ Ready!</h2>
                    <p style="font-size: 1.2em; color: #6b7280;">Select an action from the menu</p>
                </div>
            `;
        }

        async function setupDB() {
            const content = document.getElementById('content');
            content.innerHTML = '<h2>ğŸ”§ Setting up database...</h2>';
            try {
                await client.send({ zKey: '^Setup Database', action: 'create_schema' });
                client.renderMessage('âœ… Database ready!', 'success', content);
                setTimeout(listUsers, 1000);
            } catch (err) {
                client.renderMessage('âŒ ' + err.message, 'error', content);
            }
        }

        async function listUsers() {
            const content = document.getElementById('content');
            content.innerHTML = '<h2>ğŸ“‹ User List</h2><p>Loading...</p>';
            
            try {
                const users = await client.send({ zKey: '^List Users', action: 'list_users' });
                content.innerHTML = '<h2 style="margin-bottom: 1.5rem;">ğŸ“‹ User List</h2>';
                
                if (users?.length) {
                    const userData = users.map(u => 
                        Array.isArray(u) ? { id: u[0], email: u[1], name: u[2], created_at: u[3] } : u
                    );
                    const div = document.createElement('div');
                    content.appendChild(div);
                    client.renderTable(userData, div);
                } else {
                    content.innerHTML += '<div class="zPanel"><p style="text-align: center;">No users found</p></div>';
                }
            } catch (err) {
                client.renderMessage('âŒ ' + err.message, 'error', content);
            }
        }

        function addUser() {
            document.getElementById('content').innerHTML = '<h2 style="margin-bottom: 1.5rem;">â• Add User</h2>';
            client.renderForm([
                { name: 'name', label: 'Name', type: 'text', required: true },
                { name: 'email', label: 'Email', type: 'email', required: true }
            ], '#content', async (data) => {
                try {
                    await client.send({ zKey: '^Add User', action: 'add_user', data });
                    client.renderMessage('âœ… User added!', 'success', '#content');
                    setTimeout(listUsers, 1000);
                } catch (err) {
                    client.renderMessage('âŒ ' + err.message, 'error', '#content');
                }
            });
        }

        function search() {
            document.getElementById('content').innerHTML = '<h2 style="margin-bottom: 1.5rem;">ğŸ” Search Users</h2>';
            client.renderForm([
                { name: 'search_term', label: 'Search', type: 'text', placeholder: 'Name or email...', required: true }
            ], '#content', async (data) => {
                const results = document.createElement('div');
                results.style.marginTop = '2rem';
                results.innerHTML = '<h3>Results</h3><p>Searching...</p>';
                document.getElementById('content').appendChild(results);
                
                try {
                    const found = await client.send({ zKey: '^Search User', action: 'search_users', data });
                    
                    if (found?.length) {
                        const userData = found.map(u => 
                            Array.isArray(u) ? { id: u[0], email: u[1], name: u[2], created_at: u[3] } : u
                        );
                        results.innerHTML = '<h3 style="margin-bottom: 1rem;">Results</h3>';
                        const div = document.createElement('div');
                        results.appendChild(div);
                        client.renderTable(userData, div);
                    } else {
                        results.innerHTML = '<h3>Results</h3><div class="zPanel"><p style="text-align: center;">No results</p></div>';
                    }
                } catch (err) {
                    client.renderMessage('âŒ ' + err.message, 'error', results);
                }
            });
        }

        function deleteUser() {
            document.getElementById('content').innerHTML = '<h2 style="margin-bottom: 1rem;">ğŸ—‘ï¸ Delete User</h2>';
            client.renderMessage('âš ï¸ This action cannot be undone!', 'warning', '#content');
            client.renderForm([
                { name: 'user_id', label: 'User ID', type: 'number', required: true }
            ], '#content', async (data) => {
                if (!confirm(`Delete user #${data.user_id}?`)) return;
                
                try {
                    await client.send({ zKey: '^Delete User', action: 'delete_user', data });
                    client.renderMessage('âœ… User deleted!', 'success', '#content');
                    setTimeout(listUsers, 1000);
                } catch (err) {
                    client.renderMessage('âŒ ' + err.message, 'error', '#content');
                }
            });
        }
    </script>
</body>
</html>
