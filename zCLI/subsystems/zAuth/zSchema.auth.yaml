# zSchema.auth.yaml - Unified Authentication Schema (v1.5.4)
# Contains both sessions and permissions tables in ONE database
# This eliminates schema-switching issues and enables JOIN queries

Meta:
  Data_Type: sqlite
  Data_Label: "auth"
  Data_Path: "@"
  Data_Paradigm: classical

# ═══════════════════════════════════════════════════════════════════════════
# Sessions Table - Persistent Authentication State
# ═══════════════════════════════════════════════════════════════════════════
sessions:
  session_id:
    type: str
    pk: true
    required: true
    description: "Unique session identifier (32-byte token)"
  
  user_id:
    type: str
    required: true
    description: "User's unique identifier"
  
  username:
    type: str
    required: true
    description: "Username for authentication"
  
  role:
    type: str
    required: false
    default: "user"
    description: "User's role (user, admin, moderator, etc.)"
  
  password_hash:
    type: str
    required: true
    description: "bcrypt hashed password"
  
  token:
    type: str
    required: true
    description: "API authentication token"
  
  created_at:
    type: datetime
    default: now
    description: "Session creation timestamp"
  
  expires_at:
    type: datetime
    required: true
    description: "Session expiration timestamp (7 days default)"
  
  last_accessed:
    type: datetime
    default: now
    description: "Last session access timestamp"

# ═══════════════════════════════════════════════════════════════════════════
# User Permissions Table - RBAC (Role-Based Access Control)
# ═══════════════════════════════════════════════════════════════════════════
user_permissions:
  id:
    type: int
    pk: true
    auto_increment: true
    description: "Unique permission record ID"
  
  user_id:
    type: str
    required: true
    description: "User ID (not FK - permissions persist beyond sessions)"
  
  permission:
    type: str
    required: true
    description: "Permission identifier (e.g., 'users.delete', 'system.shutdown')"
  
  granted_by:
    type: str
    required: false
    default: "system"
    description: "Username of admin who granted this permission"
  
  granted_at:
    type: datetime
    default: now
    description: "Timestamp when permission was granted"

# ═══════════════════════════════════════════════════════════════════════════
# Example JOIN Query (via zData):
# ═══════════════════════════════════════════════════════════════════════════
# Get all permissions for a user:
#   z.data.select(
#       tables=["sessions", "user_permissions"],
#       joins=[{"table": "user_permissions", "on": "sessions.user_id = user_permissions.user_id"}],
#       where="sessions.username = 'admin'",
#       fields=["sessions.username", "sessions.role", "user_permissions.permission"]
#   )
# ═══════════════════════════════════════════════════════════════════════════

